{% extends '_layouts/cp' %}
{% import '_includes/forms.twig' as forms %}

{% do view.registerAssetBundle('samuelreichor\\insights\\web\\assets\\InsightsAsset') %}

{% set title = 'Insights' %}
{% set selectedSubnavItem = 'dashboard' %}

{% set crumbs = [] %}

{% block content %}
<div class="insights-dashboard">
    {# Header with Filters #}
    <div class="insights-header">
        <h1>Dashboard</h1>
        <div class="insights-filters">
            {% if sites|length > 1 %}
            <select id="site-select" class="text">
                {% for site in sites %}
                <option value="{{ site.id }}" {{ site.id == selectedSiteId ? 'selected' }}>
                    {{ site.name }}
                </option>
                {% endfor %}
            </select>
            {% endif %}
            <select id="range-select" class="text">
                <option value="today" {{ selectedRange == 'today' ? 'selected' }}>{{ 'Today'|t('insights') }}</option>
                <option value="7d" {{ selectedRange == '7d' ? 'selected' }}>{{ 'Last 7 Days'|t('insights') }}</option>
                <option value="30d" {{ selectedRange == '30d' ? 'selected' }}>{{ 'Last 30 Days'|t('insights') }}</option>
                <option value="90d" {{ selectedRange == '90d' ? 'selected' }}>{{ 'Last 90 Days'|t('insights') }}</option>
                <option value="12m" {{ selectedRange == '12m' ? 'selected' }}>{{ 'Last 12 Months'|t('insights') }}</option>
            </select>
        </div>
    </div>

    {# Realtime Section #}
    {% if settings.showRealtimeWidget %}
    <div class="insights-realtime">
        <div class="insights-realtime-indicator"></div>
        <div>
            <div class="insights-realtime-count" id="realtime-count">{{ realtime.count }}</div>
            <div class="insights-realtime-label">{{ 'Active visitors right now'|t('insights') }}</div>
        </div>
        <div class="insights-realtime-pages" id="realtime-pages">
            {% for page in realtime.pages|slice(0, 5) %}
            <div class="realtime-page">
                <span class="url">{{ page.url }}</span>
                <span class="count">{{ page.count }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# KPI Cards #}
    <div class="insights-kpis">
        <div class="insights-kpi">
            <div class="insights-kpi-label">{{ 'Pageviews'|t('insights') }}</div>
            <div class="insights-kpi-value">{{ summary.pageviews|number_format }}</div>
            <div class="insights-kpi-trend {{ summary.pageviewsTrend >= 0 ? 'positive' : 'negative' }}">
                {% if summary.pageviewsTrend >= 0 %}
                    <span>&#8593;</span>
                {% else %}
                    <span>&#8595;</span>
                {% endif %}
                {{ summary.pageviewsTrend|abs }}% {{ 'vs previous period'|t('insights') }}
            </div>
        </div>
        <div class="insights-kpi">
            <div class="insights-kpi-label">{{ 'Unique Visitors'|t('insights') }}</div>
            <div class="insights-kpi-value">{{ summary.uniqueVisitors|number_format }}</div>
            <div class="insights-kpi-trend {{ summary.visitorsTrend >= 0 ? 'positive' : 'negative' }}">
                {% if summary.visitorsTrend >= 0 %}
                    <span>&#8593;</span>
                {% else %}
                    <span>&#8595;</span>
                {% endif %}
                {{ summary.visitorsTrend|abs }}% {{ 'vs previous period'|t('insights') }}
            </div>
        </div>
        <div class="insights-kpi">
            <div class="insights-kpi-label">{{ 'Avg. Time on Page'|t('insights') }}</div>
            <div class="insights-kpi-value">
                {% set minutes = (summary.avgTimeOnPage / 60)|round(0, 'floor') %}
                {% set seconds = summary.avgTimeOnPage % 60 %}
                {{ minutes }}m {{ seconds }}s
            </div>
            <div class="insights-kpi-trend neutral">{{ 'Average per pageview'|t('insights') }}</div>
        </div>
        <div class="insights-kpi">
            <div class="insights-kpi-label">{{ 'Bounce Rate'|t('insights') }}</div>
            <div class="insights-kpi-value">{{ summary.bounceRate }}%</div>
            <div class="insights-kpi-trend neutral">{{ 'Single page visits'|t('insights') }}</div>
        </div>
    </div>

    {# Chart #}
    <div class="insights-chart-container">
        <div class="insights-chart-header">
            <h2>{{ 'Traffic Overview'|t('insights') }}</h2>
        </div>
        <div class="insights-chart-wrapper">
            <canvas id="insights-chart"></canvas>
        </div>
    </div>

    {# Data Tables Grid #}
    <div class="insights-grid">
        {# Top Pages #}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Top Pages'|t('insights') }}</h2>
                <a href="{{ cpUrl('insights/pages', { siteId: selectedSiteId, range: selectedRange }) }}">{{ 'View all'|t('insights') }}</a>
            </div>
            {% if topPages|length %}
            <table class="insights-table">
                <thead>
                    <tr>
                        <th>{{ 'Page'|t('insights') }}</th>
                        <th class="number">{{ 'Views'|t('insights') }}</th>
                        <th class="number">{{ 'Visitors'|t('insights') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% set maxViews = topPages[0].views ?? 1 %}
                    {% for page in topPages %}
                    <tr>
                        <td class="url" title="{{ page.url }}">{{ page.url }}</td>
                        <td class="number">{{ page.views|number_format }}</td>
                        <td class="number">{{ page.uniqueVisitors|number_format }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="insights-empty">
                <p>{{ 'No data available yet'|t('insights') }}</p>
            </div>
            {% endif %}
        </div>

        {# Top Referrers #}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Traffic Sources'|t('insights') }}</h2>
                <a href="{{ cpUrl('insights/referrers', { siteId: selectedSiteId, range: selectedRange }) }}">{{ 'View all'|t('insights') }}</a>
            </div>
            {% if topReferrers|length %}
            <table class="insights-table">
                <thead>
                    <tr>
                        <th>{{ 'Source'|t('insights') }}</th>
                        <th>{{ 'Type'|t('insights') }}</th>
                        <th class="number">{{ 'Visits'|t('insights') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ref in topReferrers %}
                    <tr>
                        <td>{{ ref.referrerDomain ?? 'Direct' }}</td>
                        <td>
                            <span class="insights-badge {{ ref.referrerType }}">{{ ref.referrerType }}</span>
                        </td>
                        <td class="number">{{ ref.visits|number_format }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="insights-empty">
                <p>{{ 'No referrer data yet'|t('insights') }}</p>
            </div>
            {% endif %}
        </div>

        {# Top Countries #}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Top Countries'|t('insights') }}</h2>
            </div>
            {% if topCountries|length %}
            <table class="insights-table">
                <thead>
                    <tr>
                        <th>{{ 'Country'|t('insights') }}</th>
                        <th class="number">{{ 'Visits'|t('insights') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for country in topCountries %}
                    <tr>
                        <td class="insights-country">
                            <span class="insights-country-flag">{{ craft.insights.getCountryFlag(country.countryCode) }}</span>
                            <span>{{ craft.insights.getCountryName(country.countryCode) }}</span>
                        </td>
                        <td class="number">{{ country.visits|number_format }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="insights-empty">
                <p>{{ 'No country data yet'|t('insights') }}</p>
            </div>
            {% endif %}
        </div>

        {# Devices #}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Devices & Browsers'|t('insights') }}</h2>
            </div>
            {% if devices|length %}
            <table class="insights-table">
                <thead>
                    <tr>
                        <th>{{ 'Device'|t('insights') }}</th>
                        <th class="number">{{ 'Visits'|t('insights') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr>
                        <td>{{ device.deviceType|capitalize }}</td>
                        <td class="number">{{ device.visits|number_format }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--insights-gray-200);">
            <table class="insights-table">
                <thead>
                    <tr>
                        <th>{{ 'Browser'|t('insights') }}</th>
                        <th class="number">{{ 'Visits'|t('insights') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for browser in browsers|slice(0, 5) %}
                    <tr>
                        <td>{{ browser.browserFamily ?? 'Unknown' }}</td>
                        <td class="number">{{ browser.visits|number_format }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="insights-empty">
                <p>{{ 'No device data yet'|t('insights') }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    {# Footer #}
    <div class="insights-footer">
        <span class="insights-privacy-badge">100% DSGVO-konform</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    InsightsDashboard.init({
        siteId: {{ selectedSiteId }},
        range: '{{ selectedRange }}',
        chartData: {{ chartData|json_encode|raw }}
    });
});
</script>
{% endblock %}
