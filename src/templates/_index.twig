{% extends '_layouts/cp' %}
{% import '_includes/forms.twig' as forms %}

{% do view.registerAssetBundle('samuelreichor\\insights\\web\\assets\\InsightsAsset') %}

{% set title = 'Insights' %}
{% set selectedSubnavItem = 'dashboard' %}

{# Site Selection via Breadcrumbs #}
{% set selectableSites = craft.app.sites.getEditableSites() %}
{% set selectedSite = craft.app.sites.getSiteById(selectedSiteId) %}

{% set crumbs = [] %}
{% if craft.app.getIsMultiSite() %}
    {% set crumbs = crumbs|merge([{
        id: 'site-crumb',
        icon: 'world',
        label: selectedSite.name|t('site'),
        menu: {
            items: siteMenuItems(selectableSites, selectedSite),
            label: 'Select site'|t('app')
        },
    }]) %}
{% endif %}

{% block content %}
<div class="insights-dashboard">
    <div class="flex" style="margin-bottom: 24px; gap: 12px; align-items: center;">
        <div>
            {{ forms.selectField({
                id: 'range-select',
                name: 'range',
                options: [
                    { label: 'Today'|t('insights'), value: 'today' },
                    { label: 'Last 7 Days'|t('insights'), value: '7d' },
                    { label: 'Last 30 Days'|t('insights'), value: '30d' },
                    { label: 'Last 90 Days'|t('insights'), value: '90d' },
                    { label: 'Last 12 Months'|t('insights'), value: '12m' },
                ],
                value: selectedRange,
            }) }}
        </div>
    </div>

    {# Realtime Widget #}
    {% if settings.showRealtimeWidget and currentUser.can('insights:viewDashboardRealtime') %}
    <div class="insights-realtime">
        <div class="insights-realtime-counter">
            <div class="insights-realtime-dot"></div>
            <div class="insights-realtime-info">
                <span class="insights-realtime-count" id="realtime-count">{{ realtime.count }}</span>
                <span class="insights-realtime-label">{{ 'visitors online'|t('insights') }}</span>
            </div>
        </div>
        {% if realtime.pages|length %}
        <div class="insights-realtime-divider"></div>
        <div class="insights-realtime-pages-section">
            <div class="insights-realtime-pages-title">{{ 'Currently viewing'|t('insights') }}</div>
            <ul class="insights-realtime-pages" id="realtime-pages">
                {% for page in realtime.pages|slice(0, 6) %}
                <li class="realtime-page">
                    <span class="count">{{ page.count }}</span>
                    <span class="url">{{ page.url }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {# KPI Cards #}
    {% if currentUser.can('insights:viewDashboardKpis') %}
    <div class="insights-kpis" id="insights-kpis">
        <div class="insights-kpi" data-kpi="pageviews">
            <div class="insights-kpi-label">{{ 'Pageviews'|t('insights') }}</div>
            <div class="insights-kpi-value">{{ summary.pageviews|number_format }}</div>
            <div class="insights-kpi-trend {{ summary.pageviewsTrend >= 0 ? 'positive' : 'negative' }}">
                {% if summary.pageviewsTrend >= 0 %}
                    <span>&#8593;</span>
                {% else %}
                    <span>&#8595;</span>
                {% endif %}
                {{ summary.pageviewsTrend|abs }}% {{ 'vs previous period'|t('insights') }}
            </div>
        </div>
        <div class="insights-kpi" data-kpi="visitors">
            <div class="insights-kpi-label">{{ 'Unique Visitors'|t('insights') }}</div>
            <div class="insights-kpi-value">{{ summary.uniqueVisitors|number_format }}</div>
            <div class="insights-kpi-trend {{ summary.visitorsTrend >= 0 ? 'positive' : 'negative' }}">
                {% if summary.visitorsTrend >= 0 %}
                    <span>&#8593;</span>
                {% else %}
                    <span>&#8595;</span>
                {% endif %}
                {{ summary.visitorsTrend|abs }}% {{ 'vs previous period'|t('insights') }}
            </div>
        </div>
        <div class="insights-kpi" data-kpi="avgTime">
            <div class="insights-kpi-label">{{ 'Avg. Time on Page'|t('insights') }}</div>
            <div class="insights-kpi-value">
                {% set minutes = (summary.avgTimeOnPage / 60)|round(0, 'floor') %}
                {% set seconds = summary.avgTimeOnPage % 60 %}
                {{ minutes }}m {{ seconds }}s
            </div>
            <div class="insights-kpi-trend neutral">{{ 'Average per pageview'|t('insights') }}</div>
        </div>
        <div class="insights-kpi" data-kpi="bounceRate">
            <div class="insights-kpi-label">{{ 'Bounce Rate'|t('insights') }}</div>
            <div class="insights-kpi-value">{{ summary.bounceRate }}%</div>
            <div class="insights-kpi-trend neutral">{{ 'Single page visits'|t('insights') }}</div>
        </div>
    </div>
    {% endif %}

    {# Chart #}
    {% if currentUser.can('insights:viewDashboardChart') %}
    <div class="insights-chart-container">
        <div class="insights-chart-header">
            <h2>{{ 'Traffic Overview'|t('insights') }}</h2>
        </div>
        <div class="insights-chart-wrapper">
            <canvas id="insights-chart"></canvas>
        </div>
    </div>
    {% endif %}

    {# Data Tables Grid #}
    <div class="insights-grid">
        {# Top Pages #}
        {% if currentUser.can('insights:viewDashboardPages') %}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Top Pages'|t('insights') }}</h2>
                {% if currentUser.can('insights:viewPages') %}
                <a href="{{ cpUrl('insights/pages', { siteId: selectedSiteId, range: selectedRange }) }}">{{ 'View all'|t('insights') }}</a>
                {% endif %}
            </div>
            {% if topPages|length %}
            <table class="insights-table" id="table-top-pages">
                <thead>
                    <tr>
                        <th>{{ 'Page'|t('insights') }}</th>
                        <th class="number">{{ 'Views'|t('insights') }}</th>
                        <th class="number">{{ 'Visitors'|t('insights') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% set maxViews = topPages[0].views ?? 1 %}
                    {% for page in topPages %}
                    <tr>
                        <td class="url" title="{{ page.url }}">{{ page.url }}</td>
                        <td class="number">{{ page.views|number_format }}</td>
                        <td class="number">{{ page.uniqueVisitors|number_format }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="insights-empty">
                <p>{{ 'No data available yet'|t('insights') }}</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {# Top Referrers #}
        {% if currentUser.can('insights:viewDashboardReferrers') %}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Traffic Sources'|t('insights') }}</h2>
                {% if currentUser.can('insights:viewReferrers') %}
                <a href="{{ cpUrl('insights/referrers', { siteId: selectedSiteId, range: selectedRange }) }}">{{ 'View all'|t('insights') }}</a>
                {% endif %}
            </div>
            {% if topReferrers|length %}
            <table class="insights-table" id="table-top-referrers">
                <thead>
                    <tr>
                        <th>{{ 'Source'|t('insights') }}</th>
                        <th>{{ 'Type'|t('insights') }}</th>
                        <th class="number">{{ 'Visits'|t('insights') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ref in topReferrers %}
                    <tr>
                        <td>{{ ref.referrerDomain ?? 'Direct' }}</td>
                        <td>
                            <span class="insights-badge {{ ref.referrerType }}">{{ ref.referrerType }}</span>
                        </td>
                        <td class="number">{{ ref.visits|number_format }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="insights-empty">
                <p>{{ 'No referrer data yet'|t('insights') }}</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {# Devices #}
        {% if currentUser.can('insights:viewDashboardDevices') %}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Devices & Browsers'|t('insights') }}</h2>
            </div>
            {% if devices|length %}
            <table class="insights-table" id="table-devices">
                <thead>
                    <tr>
                        <th>{{ 'Device'|t('insights') }}</th>
                        <th class="number">{{ 'Visits'|t('insights') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for device in devices %}
                    <tr>
                        <td>{{ device.deviceType|capitalize }}</td>
                        <td class="number">{{ device.visits|number_format }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <hr style="margin: 16px 0; border: none; border-top: 1px solid var(--insights-gray-200);">
            <table class="insights-table" id="table-browsers">
                <thead>
                    <tr>
                        <th>{{ 'Browser'|t('insights') }}</th>
                        <th class="number">{{ 'Visits'|t('insights') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for browser in browsers|slice(0, 5) %}
                    <tr>
                        <td>{{ browser.browserFamily ?? 'Unknown' }}</td>
                        <td class="number">{{ browser.visits|number_format }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="insights-empty">
                <p>{{ 'No device data yet'|t('insights') }}</p>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {# Top Countries #}
        {% if currentUser.can('insights:viewDashboardCountries') %}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Top Countries'|t('insights') }}</h2>
                {% if not plugin('insights').is('pro') %}
                <span class="insights-badge-pro">Pro</span>
                {% elseif currentUser.can('insights:viewCountries') %}
                <a href="{{ cpUrl('insights/countries', { siteId: selectedSiteId, range: selectedRange }) }}">{{ 'View all'|t('insights') }}</a>
                {% endif %}
            </div>
            {% if plugin('insights').is('pro') %}
                {% if topCountries|length %}
                <table class="insights-table" id="table-top-countries">
                    <thead>
                        <tr>
                            <th>{{ 'Country'|t('insights') }}</th>
                            <th class="number">{{ 'Visits'|t('insights') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for country in topCountries %}
                        <tr>
                            <td class="insights-country">
                                <span class="insights-country-flag">{{ craft.insights.getCountryFlag(country.countryCode) }}</span>
                                <span>{{ craft.insights.getCountryName(country.countryCode) }}</span>
                            </td>
                            <td class="number">{{ country.visits|number_format }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="insights-empty">
                    <p>{{ 'No country data yet'|t('insights') }}</p>
                </div>
                {% endif %}
            {% else %}
                <div class="insights-preview-wrapper">
                    {% if proPreviews.countries|length %}
                    <table class="insights-table insights-blurred" aria-hidden="true">
                        <thead>
                            <tr>
                                <th>{{ 'Country'|t('insights') }}</th>
                                <th class="number">{{ 'Visits'|t('insights') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Placeholder rows based on real data count - upgrade to Pro to see actual values #}
                            {% for item in proPreviews.countries %}
                            <tr><td class="insights-country"><span class="insights-country-flag">üè≥Ô∏è</span><span>Sample Country</span></td><td class="number">---</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="insights-empty insights-blurred">
                        <p>{{ 'No country data yet'|t('insights') }}</p>
                    </div>
                    {% endif %}
                    <div class="insights-preview-overlay">
                        <div class="insights-preview-lock">
                            <span class="insights-lock-icon">üîí</span>
                        </div>
                        <a href="{{ cpUrl('plugin-store/insights') }}" class="btn">{{ 'Upgrade to unlock'|t('insights') }}</a>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}

        {# Session Insights (Combined Widget) #}
        {% if currentUser.can('insights:viewDashboardEntryExitPages') %}
        <div class="insights-table-container insights-session-widget insights-full-width-lg">
            <div class="insights-table-header">
                <h2>{{ 'Session Insights'|t('insights') }}</h2>
                {% if not plugin('insights').is('pro') %}
                <span class="insights-badge-pro">Pro</span>
                {% elseif currentUser.can('insights:viewEntryExitPages') %}
                <a href="{{ cpUrl('insights/entry-exit-pages', { siteId: selectedSiteId, range: selectedRange }) }}" class="insights-view-all">{{ 'View all'|t('insights') }}</a>
                {% endif %}
            </div>

            {% if plugin('insights').is('pro') %}
                {# Pages per Session KPI #}
                <div class="insights-session-kpi" data-kpi="pagesPerSession">
                    <div class="insights-session-kpi-main">
                        <span class="insights-session-kpi-value">{{ pagesPerSession.avgPagesPerSession }}</span>
                        <span class="insights-session-kpi-label">{{ 'Pages / Session'|t('insights') }}</span>
                    </div>
                    {% if pagesPerSession.avgPagesPerSessionTrend is not null %}
                    <div class="insights-session-kpi-trend {{ pagesPerSession.avgPagesPerSessionTrend >= 0 ? 'positive' : 'negative' }}">
                        {% if pagesPerSession.avgPagesPerSessionTrend >= 0 %}
                            <span>&#8593;</span>
                        {% else %}
                            <span>&#8595;</span>
                        {% endif %}
                        {{ pagesPerSession.avgPagesPerSessionTrend|abs }}%
                    </div>
                    {% endif %}
                </div>

                {# Entry/Exit Pages Side by Side #}
                <div class="insights-entry-exit-tables">
                    <div class="insights-entry-exit-col">
                        <h4>{{ 'Entry Pages'|t('insights') }}</h4>
                        {% if topEntryPages|length %}
                        <table class="insights-table insights-table-compact" id="table-entry-pages">
                            <thead>
                                <tr>
                                    <th>{{ 'Page'|t('insights') }}</th>
                                    <th class="number">{{ 'Sessions'|t('insights') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for page in topEntryPages|slice(0, 5) %}
                                <tr>
                                    <td class="url" title="{{ page.url }}">{{ page.url }}</td>
                                    <td class="number">{{ page.sessions|number_format }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="insights-empty-small">
                            <p>{{ 'No data yet'|t('insights') }}</p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="insights-entry-exit-col">
                        <h4>{{ 'Exit Pages'|t('insights') }}</h4>
                        {% if topExitPages|length %}
                        <table class="insights-table insights-table-compact" id="table-exit-pages">
                            <thead>
                                <tr>
                                    <th>{{ 'Page'|t('insights') }}</th>
                                    <th class="number">{{ 'Sessions'|t('insights') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for page in topExitPages|slice(0, 5) %}
                                <tr>
                                    <td class="url" title="{{ page.url }}">{{ page.url }}</td>
                                    <td class="number">{{ page.sessions|number_format }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="insights-empty-small">
                            <p>{{ 'No data yet'|t('insights') }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                {# Lite Preview #}
                <div class="insights-preview-wrapper">
                    <div class="insights-session-kpi">
                        <div class="insights-session-kpi-main">
                            <span class="insights-session-kpi-value">--</span>
                            <span class="insights-session-kpi-label">{{ 'Pages / Session'|t('insights') }}</span>
                        </div>
                    </div>
                    <div class="insights-entry-exit-tables insights-blurred" aria-hidden="true">
                        <div class="insights-entry-exit-col">
                            <h4>{{ 'Entry Pages'|t('insights') }}</h4>
                            <table class="insights-table insights-table-compact">
                                <thead><tr><th>{{ 'Page'|t('insights') }}</th><th class="number">{{ 'Sessions'|t('insights') }}</th></tr></thead>
                                <tbody>
                                    <tr><td>/home</td><td class="number">---</td></tr>
                                    <tr><td>/landing</td><td class="number">---</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="insights-entry-exit-col">
                            <h4>{{ 'Exit Pages'|t('insights') }}</h4>
                            <table class="insights-table insights-table-compact">
                                <thead><tr><th>{{ 'Page'|t('insights') }}</th><th class="number">{{ 'Sessions'|t('insights') }}</th></tr></thead>
                                <tbody>
                                    <tr><td>/checkout</td><td class="number">---</td></tr>
                                    <tr><td>/contact</td><td class="number">---</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="insights-preview-overlay">
                        <div class="insights-preview-lock">
                            <span class="insights-lock-icon">üîí</span>
                        </div>
                        <a href="{{ cpUrl('plugin-store/insights') }}" class="btn">{{ 'Upgrade to unlock'|t('insights') }}</a>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}

        {# Scroll Depth (Pro only) #}
        {% if currentUser.can('insights:viewDashboardScrollDepth') %}
        <div class="insights-table-container insights-full-width-lg">
            <div class="insights-table-header">
                <h2>{{ 'Scroll Depth'|t('insights') }}</h2>
                {% if not plugin('insights').is('pro') %}
                <span class="insights-badge-pro">Pro</span>
                {% elseif currentUser.can('insights:viewScrollDepth') %}
                <a href="{{ cpUrl('insights/scroll-depth', { siteId: selectedSiteId, range: selectedRange }) }}" class="insights-view-all">{{ 'View all'|t('insights') }}</a>
                {% endif %}
            </div>
            {% if plugin('insights').is('pro') %}
                {% if scrollDepth|length %}
                {# Average Scroll Depth KPI #}
                {% if avgScrollDepth %}
                <div class="insights-scroll-depth-summary">
                    <div class="insights-scroll-kpi">
                        <span class="insights-scroll-kpi-value">{{ avgScrollDepth.avgScrollDepth }}%</span>
                        <span class="insights-scroll-kpi-label">{{ 'Avg. Scroll Depth'|t('insights') }}</span>
                    </div>
                    <div class="insights-scroll-milestones">
                        <div class="milestone">
                            <span class="milestone-label">25%</span>
                            <span class="milestone-value">{{ avgScrollDepth.milestone25|number_format }}</span>
                        </div>
                        <div class="milestone">
                            <span class="milestone-label">50%</span>
                            <span class="milestone-value">{{ avgScrollDepth.milestone50|number_format }}</span>
                        </div>
                        <div class="milestone">
                            <span class="milestone-label">75%</span>
                            <span class="milestone-value">{{ avgScrollDepth.milestone75|number_format }}</span>
                        </div>
                        <div class="milestone">
                            <span class="milestone-label">100%</span>
                            <span class="milestone-value">{{ avgScrollDepth.milestone100|number_format }}</span>
                        </div>
                    </div>
                </div>
                {% endif %}
                <table class="insights-table" id="table-scroll-depth">
                    <thead>
                        <tr>
                            <th>{{ 'Page'|t('insights') }}</th>
                            <th class="number">25%</th>
                            <th class="number">50%</th>
                            <th class="number">75%</th>
                            <th class="number">100%</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for page in scrollDepth %}
                        <tr>
                            <td class="url" title="{{ page.url }}">{{ page.url }}</td>
                            <td class="number">{{ page.milestone25|number_format }}</td>
                            <td class="number">{{ page.milestone50|number_format }}</td>
                            <td class="number">{{ page.milestone75|number_format }}</td>
                            <td class="number">{{ page.milestone100|number_format }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="insights-empty">
                    <p>{{ 'No scroll depth data yet'|t('insights') }}</p>
                    <p class="insights-muted">{{ 'Scroll depth is tracked automatically at 25%, 50%, 75%, and 100%.'|t('insights') }}</p>
                </div>
                {% endif %}
            {% else %}
                <div class="insights-preview-wrapper">
                    <div class="insights-scroll-depth-summary insights-blurred">
                        <div class="insights-scroll-kpi">
                            <span class="insights-scroll-kpi-value">---%</span>
                            <span class="insights-scroll-kpi-label">{{ 'Avg. Scroll Depth'|t('insights') }}</span>
                        </div>
                        <div class="insights-scroll-milestones">
                            <div class="milestone"><span class="milestone-label">25%</span><span class="milestone-value">---</span></div>
                            <div class="milestone"><span class="milestone-label">50%</span><span class="milestone-value">---</span></div>
                            <div class="milestone"><span class="milestone-label">75%</span><span class="milestone-value">---</span></div>
                            <div class="milestone"><span class="milestone-label">100%</span><span class="milestone-value">---</span></div>
                        </div>
                    </div>
                    <div class="insights-preview-overlay">
                        <div class="insights-preview-lock">
                            <span class="insights-lock-icon">üîí</span>
                        </div>
                        <a href="{{ cpUrl('plugin-store/insights') }}" class="btn">{{ 'Upgrade to unlock'|t('insights') }}</a>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}

        {# Top Campaigns #}
        {% if currentUser.can('insights:viewDashboardCampaigns') %}
        <div class="insights-table-container insights-full-width-lg">
            <div class="insights-table-header">
                <h2>{{ 'Campaigns'|t('insights') }}</h2>
                {% if not plugin('insights').is('pro') %}
                <span class="insights-badge-pro">Pro</span>
                {% elseif currentUser.can('insights:viewCampaigns') %}
                <a href="{{ cpUrl('insights/campaigns', { siteId: selectedSiteId, range: selectedRange }) }}">{{ 'View all'|t('insights') }}</a>
                {% endif %}
            </div>
            {% if plugin('insights').is('pro') %}
                {% if topCampaigns|length %}
                <table class="insights-table" id="table-top-campaigns">
                    <thead>
                        <tr>
                            <th>{{ 'Source'|t('insights') }}</th>
                            <th>{{ 'Medium'|t('insights') }}</th>
                            <th>{{ 'Campaign'|t('insights') }}</th>
                            <th class="number">{{ 'Visits'|t('insights') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for campaign in topCampaigns %}
                        <tr>
                            <td>{{ campaign.utmSource ?? '-' }}</td>
                            <td>{{ campaign.utmMedium ?? '-' }}</td>
                            <td>{{ campaign.utmCampaign ?? '-' }}</td>
                            <td class="number">{{ campaign.visits|number_format }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="insights-empty">
                    <p>{{ 'No campaign data yet'|t('insights') }}</p>
                    <p class="insights-muted">{{ 'Use UTM parameters (utm_source, utm_medium, utm_campaign) to track campaigns.'|t('insights') }}</p>
                </div>
                {% endif %}
            {% else %}
                <div class="insights-preview-wrapper">
                    {% if proPreviews.campaigns|length %}
                    <table class="insights-table insights-blurred" aria-hidden="true">
                        <thead>
                            <tr>
                                <th>{{ 'Source'|t('insights') }}</th>
                                <th>{{ 'Medium'|t('insights') }}</th>
                                <th>{{ 'Campaign'|t('insights') }}</th>
                                <th class="number">{{ 'Visits'|t('insights') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Placeholder rows based on real data count - upgrade to Pro to see actual values #}
                            {% for item in proPreviews.campaigns %}
                            <tr><td>example-source</td><td>sample-medium</td><td>campaign-name</td><td class="number">---</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="insights-empty insights-blurred">
                        <p>{{ 'No campaign data yet'|t('insights') }}</p>
                    </div>
                    {% endif %}
                    <div class="insights-preview-overlay">
                        <div class="insights-preview-lock">
                            <span class="insights-lock-icon">üîí</span>
                        </div>
                        <a href="{{ cpUrl('plugin-store/insights') }}" class="btn">{{ 'Upgrade to unlock'|t('insights') }}</a>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}

        {# Top Events #}
        {% if currentUser.can('insights:viewDashboardEvents') %}
        <div class="insights-table-container insights-full-width-lg">
            <div class="insights-table-header">
                <h2>{{ 'Top Events'|t('insights') }}</h2>
                {% if not plugin('insights').is('pro') %}
                <span class="insights-badge-pro">Pro</span>
                {% elseif currentUser.can('insights:viewEvents') %}
                <a href="{{ cpUrl('insights/events', { siteId: selectedSiteId, range: selectedRange }) }}">{{ 'View all'|t('insights') }}</a>
                {% endif %}
            </div>
            {% if plugin('insights').is('pro') %}
                {% if topEvents|length %}
                <table class="insights-table" id="table-top-events">
                    <thead>
                        <tr>
                            <th>{{ 'Event'|t('insights') }}</th>
                            <th>{{ 'Category'|t('insights') }}</th>
                            <th class="number">{{ 'Count'|t('insights') }}</th>
                            <th class="number">{{ 'Visitors'|t('insights') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in topEvents %}
                        <tr>
                            <td>{{ event.eventName }}</td>
                            <td>
                                {% if event.eventCategory %}
                                    <span class="insights-badge-category">{{ event.eventCategory }}</span>
                                {% else %}
                                    <span class="insights-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="number">{{ event.count|number_format }}</td>
                            <td class="number">{{ event.uniqueVisitors|number_format }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="insights-empty">
                    <p>{{ 'No event data yet'|t('insights') }}</p>
                    <p class="insights-muted">{{ 'Use data-insights-event attributes or insights.trackEvent() to track custom events.'|t('insights') }}</p>
                </div>
                {% endif %}
            {% else %}
                <div class="insights-preview-wrapper">
                    {% if proPreviews.events|length %}
                    <table class="insights-table insights-blurred" aria-hidden="true">
                        <thead>
                            <tr>
                                <th>{{ 'Event'|t('insights') }}</th>
                                <th>{{ 'Category'|t('insights') }}</th>
                                <th class="number">{{ 'Count'|t('insights') }}</th>
                                <th class="number">{{ 'Visitors'|t('insights') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Placeholder rows based on real data count - upgrade to Pro to see actual values #}
                            {% for item in proPreviews.events %}
                            <tr><td>sample_event</td><td><span class="insights-badge-category">category</span></td><td class="number">---</td><td class="number">---</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="insights-empty insights-blurred">
                        <p>{{ 'No event data yet'|t('insights') }}</p>
                    </div>
                    {% endif %}
                    <div class="insights-preview-overlay">
                        <div class="insights-preview-lock">
                            <span class="insights-lock-icon">üîí</span>
                        </div>
                        <a href="{{ cpUrl('plugin-store/insights') }}" class="btn">{{ 'Upgrade to unlock'|t('insights') }}</a>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}

        {# Top Outbound Links #}
        {% if currentUser.can('insights:viewDashboardOutbound') %}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Outbound Links'|t('insights') }}</h2>
                {% if not plugin('insights').is('pro') %}
                <span class="insights-badge-pro">Pro</span>
                {% elseif currentUser.can('insights:viewOutbound') %}
                <a href="{{ cpUrl('insights/outbound', { siteId: selectedSiteId, range: selectedRange }) }}">{{ 'View all'|t('insights') }}</a>
                {% endif %}
            </div>
            {% if plugin('insights').is('pro') %}
                {% if topOutboundLinks|length %}
                <table class="insights-table" id="table-top-outbound">
                    <thead>
                        <tr>
                            <th>{{ 'Domain'|t('insights') }}</th>
                            <th class="number">{{ 'Clicks'|t('insights') }}</th>
                            <th class="number">{{ 'Visitors'|t('insights') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for link in topOutboundLinks %}
                        <tr>
                            <td>{{ link.targetDomain }}</td>
                            <td class="number">{{ link.clicks|number_format }}</td>
                            <td class="number">{{ link.uniqueVisitors|number_format }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="insights-empty">
                    <p>{{ 'No outbound link data yet'|t('insights') }}</p>
                    <p class="insights-muted">{{ 'External links are tracked automatically when visitors click them.'|t('insights') }}</p>
                </div>
                {% endif %}
            {% else %}
                <div class="insights-preview-wrapper">
                    {% if proPreviews.outbound|length %}
                    <table class="insights-table insights-blurred" aria-hidden="true">
                        <thead>
                            <tr>
                                <th>{{ 'Domain'|t('insights') }}</th>
                                <th class="number">{{ 'Clicks'|t('insights') }}</th>
                                <th class="number">{{ 'Visitors'|t('insights') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Placeholder rows based on real data count - upgrade to Pro to see actual values #}
                            {% for item in proPreviews.outbound %}
                            <tr><td>example-domain.com</td><td class="number">---</td><td class="number">---</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="insights-empty insights-blurred">
                        <p>{{ 'No outbound link data yet'|t('insights') }}</p>
                    </div>
                    {% endif %}
                    <div class="insights-preview-overlay">
                        <div class="insights-preview-lock">
                            <span class="insights-lock-icon">üîí</span>
                        </div>
                        <a href="{{ cpUrl('plugin-store/insights') }}" class="btn">{{ 'Upgrade to unlock'|t('insights') }}</a>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}

        {# Site Searches #}
        {% if currentUser.can('insights:viewDashboardSearches') %}
        <div class="insights-table-container">
            <div class="insights-table-header">
                <h2>{{ 'Site Searches'|t('insights') }}</h2>
                {% if not plugin('insights').is('pro') %}
                <span class="insights-badge-pro">Pro</span>
                {% elseif currentUser.can('insights:viewSearches') %}
                <a href="{{ cpUrl('insights/searches', { siteId: selectedSiteId, range: selectedRange }) }}">{{ 'View all'|t('insights') }}</a>
                {% endif %}
            </div>
            {% if plugin('insights').is('pro') %}
                {% if topSearches|length %}
                <table class="insights-table" id="table-top-searches">
                    <thead>
                        <tr>
                            <th>{{ 'Search Term'|t('insights') }}</th>
                            <th class="number">{{ 'Searches'|t('insights') }}</th>
                            <th class="number">{{ 'Visitors'|t('insights') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for search in topSearches %}
                        <tr>
                            <td>{{ search.searchTerm }}</td>
                            <td class="number">{{ search.searches|number_format }}</td>
                            <td class="number">{{ search.uniqueVisitors|number_format }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="insights-empty">
                    <p>{{ 'No search data yet'|t('insights') }}</p>
                    <p class="insights-muted">{{ 'Use insights.trackSearch() to track site searches.'|t('insights') }}</p>
                </div>
                {% endif %}
            {% else %}
                <div class="insights-preview-wrapper">
                    {% if proPreviews.searches|length %}
                    <table class="insights-table insights-blurred" aria-hidden="true">
                        <thead>
                            <tr>
                                <th>{{ 'Search Term'|t('insights') }}</th>
                                <th class="number">{{ 'Searches'|t('insights') }}</th>
                                <th class="number">{{ 'Visitors'|t('insights') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Placeholder rows based on real data count - upgrade to Pro to see actual values #}
                            {% for item in proPreviews.searches %}
                            <tr><td>search query example</td><td class="number">---</td><td class="number">---</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="insights-empty insights-blurred">
                        <p>{{ 'No search data yet'|t('insights') }}</p>
                    </div>
                    {% endif %}
                    <div class="insights-preview-overlay">
                        <div class="insights-preview-lock">
                            <span class="insights-lock-icon">üîí</span>
                        </div>
                        <a href="{{ cpUrl('plugin-store/insights') }}" class="btn">{{ 'Upgrade to unlock'|t('insights') }}</a>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    InsightsDashboard.init({
        siteId: {{ selectedSiteId }},
        range: '{{ selectedRange }}',
        chartData: {{ chartData|json_encode|raw }}
    });
});
</script>
{% endblock %}
